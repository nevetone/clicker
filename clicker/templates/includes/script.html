<script>
{% load static %}

function makeCookieId(length) {
    var result = '';
    var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    var charactersLength = characters.length;
    for ( var i = 0; i < length; i++ ) {
        result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    return result;
    }

    var firstLogIn = Cookies.get('firstLogin');

    if (firstLogIn){

        console.log(Cookies.get('cookieIds')+" ponowne logowanie");
    }else{
        Cookies.set('cookieIds', makeCookieId(12), { path: '' });
        Cookies.set('firstLogin', 'false', { path: '' });
        console.log(Cookies.get('cookieIds')+' first time');
    }


$(document).ready(function(){




    // zmienne pomocnicze
    var o = -1;
    // zmienne
    var clickCount=0; // ilosc nacisniec
    var stage = 1; // aktualny stage
    var stagePassed = 1; // ilosc stage ktore przeszedles
    var clickDmg = 1; // aktualny click dmg
    var level = 1; // aktualny level na danym stage
    var maxLevel = 10; // ilosc leveli
    var gold = 998999; // base gold 
    var maxhp = 10; // pierwsze hp mobka
    var current = maxhp; // aktualne hp
    var hpbar =  current/maxhp*100; // aktualny hp bar w %%
    var hpMultipler = 1.12; // huj wi cos wojtek napisal xd

    var clickUpgradesBought = 1; // ile kupionych click upgradow
    var clickUpgradePrice=100;

    var visibleUpgrades = -1; // obecnie pokazane upgrade
    var bossTime=30;
    var time_left =bossTime;
    var b_startBossTime=false;
    var b_getBonusgold=false;

    var dpsMeter=1.0;
    var dps=0;
    var cost10=clickUpgradePrice*2*10;
    var cost25=clickUpgradePrice*2*25;
    $('#dps').text(dps.toFixed(1)+' dmg.');



    // zmienne wysp i mobków z bazy danych
    var islands = [];
    var islands_images = [];
    var islands_ends = [];

    var mobs = [];
    var mobs_images = [];
    var mobs_on_island_count = [];

// load save ------------------------------------
// jeszcze nie ma wszystkich danych ale to sa poczatki
    $('#loadSave').submit(function() {
        $.ajax({
            data: $(this).serialize(),
            type: $(this).attr('method'),
            url: $(this).attr('action'),
            success: function(data) {
                    o = data.var_o;
                    clickCount = data.click_count;
                    stage = data.stage_passed;
                    stagePassed = data.stage_passed;
                    gold = data.current_gold;
                    clickUpgradesBought = data.click_upgrades_bought;
                    clickUpgradePrice = data.clickUpgradePrice;
                    cost10=clickUpgradePrice*2*10;
                    cost25=clickUpgradePrice*2*25;
                    clickDmg = clickUpgradesBought-1;
                    refreshIsland(false);
                    refreshHTML();
                    setHp();
            }});
        return false;
    });

    function load(){
        $('#loadUser').val(Cookies.get('cookieIds'));
        $('#loadSave').submit();
    };
    load();
// koniec load save ------------------------------
    
    {% for island in islands %}
        islands.push('{{ island.island_name }}');
        islands_images.push('{{ island.island_image.url }}');
        islands_ends.push({{ island.ends }});
        {% for mob in island.units.all %}
        mobs.push('{{ mob.mob_name }}');
        mobs_images.push('{{ mob.mob_image.url }}');
        {% endfor %}
        mobs_on_island_count.push({{ island.units.count }});
    {% endfor %}

                                                                                                                    {% comment %} ) {% endcomment %}
 
// particle ---------------- na click -------------------------
if (document.body.animate) {
  document.querySelector('.click_area').addEventListener('click', pop);
}

function pop (e) {
  if (e.clientX === 0 && e.clientY === 0) {
    const bbox = document.querySelector('#button').getBoundingClientRect();
    const x = bbox.left + bbox.width / 2;
    const y = bbox.top + bbox.height / 2;
    for (let i = 0; i < 30; i++) {
      createParticle(x, y);
    }
  } else {
    for (let i = 0; i < 30; i++) {
      createParticle(e.clientX, e.clientY);
    }
  }
}

function createParticle (x, y) {
  const particle = document.createElement('particle');
  document.body.appendChild(particle);
  
  const size = Math.floor(Math.random() * 20 + 5);
  particle.style.width = `${size}px`;
  particle.style.height = `${size}px`;
  particle.style.background = `hsl(${Math.random() * 90 + 180}, 70%, 60%)`;
  
  const destinationX = x + (Math.random() - 0.5) * 2 * 75;
  const destinationY = y + (Math.random() - 0.5) * 2 * 75;
  const animation = particle.animate([
    {
      transform: `translate(-50%, -50%) translate(${x}px, ${y}px)`,
      opacity: 1
    },
    {
      transform: `translate(${destinationX}px, ${destinationY}px)`,
      opacity: 0
    }
  ], {
    duration: Math.random() * 1000 + 500,
    easing: 'cubic-bezier(0, .9, .57, 1)',
    delay: Math.random() * 200
  });
  animation.onfinish = () => {
    particle.remove();
  };
}

////////////////////////---------------------------------


      class Upgrade{  
        constructor(){
            this.nameId='';
            this.nameOfUpgrade='';
            this.baseDmg=0.5;
            this.boughtUpgrades=0;
            this.price=0;
            this.discountMultipler=1.0;
            this.priceMultipler=1.15;
        }
        buyUpgrade(){
            if(gold >= (this.price*this.discountMultipler)){
                gold -= this.price*this.discountMultipler;
                this.boughtUpgrades++;
                $('#pills-console').append('<span>Kupiłeś upgrade dla '+this.nameOfUpgrade+ ' za ' +this.price+ ' golda!</span><br/>');
                $("#pills-console").animate({ scrollTop: 20000000 }, "slow");
                this.price *= this.priceMultipler;
            }
        }
        

    };
    class SkillButton extends Upgrade {
        static skills=[];
        constructor(){
            super();
            this.isOn=false;
            this.maxTime=10;
            this.time=this.maxTime;
            this.skillType=0;
        }
        turnOn(){
            this.isOn=true;
        }
        static useSkill(){


        }
        static Init(){
            var upgradeNames = [];
            var baseUpgradePrices = [];
            
            {% for skill in skills %}
            upgradeNames.push('{{ skill.skill_name }}');
            baseUpgradePrices.push({{ skill.skill_cost }});
            {% endfor %}


        for(var i = 0;i<upgradeNames.length;i++){
            this.skills[i]=new SkillButton();
            this.skills[i].price=baseUpgradePrices[i];
            this.skills[i].nameId="#skill"+i;
            this.skills[i].nameOfUpgrade=upgradeNames[i];
            this.skills[i].baseDmg =0;
            
         };
         
        {% for skill in skills %}
        $('#skill{{ skill.skill_id }}').click(function(){SkillButton.skills[{{ skill.skill_id }}].buyUpgrade()});
        {% endfor %}

        }
        static refreshSkills(){
            for(var i = 0;i<this.skills.length;i++){
            $(this.skills[i].nameId+'_count').text(this.skills[i].boughtUpgrades);
            $(this.skills[i].nameId+'_cost').text(this.skills[i].price.toFixed(0));
            }
            if(this.on){
                this.time -=0.1;
                if(this.time>=0){
                    this.on=false;
                    this.time=maxTime;
                }
            }
        }
   };

    class UpgradeButton extends Upgrade {
        static buttons=[];
        constructor(){
            super();
            this.checked = false;
        };
        static Init(){
        var baseUpgradePrices = [];
        var upgradeNames = [];   

         {% for unit in units %}
          upgradeNames.push('{{ unit.unit_name }}');
          baseUpgradePrices.push({{ unit.unit_default_cost }}); 
         {% endfor %}

         for(var i = 0;i<upgradeNames.length;i++){
            this.buttons[i]=new UpgradeButton();
            this.buttons[i].price=baseUpgradePrices[i];
            this.buttons[i].nameId="#upgrade"+i;
            this.buttons[i].nameOfUpgrade=upgradeNames[i];
            this.buttons[i].baseDmg +=i;
         };

        {% for unit in units %}
          $('#upgrade{{ unit.unit_id }}').click(function(){UpgradeButton.buttons[{{ unit.unit_id }}].buyUpgrade()});
        {% endfor %}



        }

        static getAllDmg(){
            var dmg=0;
            for(var i = 0;i<this.buttons.length;i++){
            dmg += this.buttons[i].baseDmg*this.buttons[i].boughtUpgrades/10;
            }
            return dmg;
        }
        static refreshButtons(){
            for(var i = 0;i<this.buttons.length;i++){
            $(this.buttons[i].nameId+'_count').text(this.buttons[i].boughtUpgrades);
            $(this.buttons[i].nameId+'_cost').text(this.buttons[i].price.toFixed(0));
            $(''+this.buttons[i].nameId+'').prop('disabled', ((gold < this.buttons[i].price*this.buttons[i].discountMultipler)?true:false));
            if(gold >= this.buttons[i].price && !this.buttons[i].checked  && visibleUpgrades < this.buttons.length){
                    this.buttons[i].checked = true;
                    visibleUpgrades++;
                    }
            $('#upgrade'+visibleUpgrades.toString()).prop('hidden', false);
            }
        }

    };


    UpgradeButton.Init();
    SkillButton.Init();

            {% comment %} ) {% endcomment %}


    // zmienne random dla moba
    var last_mobs = 0;
    var min = last_mobs;
    var max = last_mobs + mobs_on_island_count[o+1] - 1;
    var islands_count = {{ islands.count }};
    $('.island').attr("src", islands_images[o+1]);

    function refreshIsland(next){
        if(islands_count >= o){
            if(next == true){
                if(stage-1 == islands_ends[o+1] ){
                    o++;
                    last_mobs = max;
                    min = max+1;
                    max = max + mobs_on_island_count[o+1];
                };
            }else{
                if(stage == islands_ends[o] ){
                    if(stage == islands_ends[0]){
                        o = -1;
                        last_mobs = 0;
                        min = last_mobs;
                        max = last_mobs + mobs_on_island_count[o+1] - 1;
                    }else{
                        min = min - mobs_on_island_count[o];
                        max = max - mobs_on_island_count[o+1];
                        o--;
                    };};
                };
            };
            minV = Math.ceil(min);
            maxV = Math.floor(max);
            k = Math.floor(Math.random() * (max - min + 1)) + min;


            $('#mob_image').attr("src",  mobs_images[k] );
            $('#mob_name').text(mobs[k]);
            $('#level_name').text(islands[o+1]);
            $('.island').attr("src", islands_images[o+1]);
    };

    function refreshHTML(){
            UpgradeButton.refreshButtons();
            SkillButton.refreshSkills();

        
        $('#gold').text(gold.toFixed(0));
        $('#boughtUpgrades').text(clickUpgradesBought-1);
        $('#goldPrice').text(clickUpgradePrice);
        $('#level').text(" "+level);
        $('#maxLevel').text(maxLevel);
        $('#stage').text(stage);
        $('#max_hp').text(maxhp.toFixed(0));
        $('.current_hp').text(current.toFixed(0));
        $('#clickDmg').text(clickDmg.toFixed(2));
        hpbar =  current/maxhp*100;
        $('.progress-bar').css('width', hpbar.toFixed(2)+'%');
        $('#clickCount').text(clickCount);
        $('#cost25').text(cost25);
        $('#cost10').text(cost10);
        $('#boss_time').prop('hidden', !b_startBossTime);
        $('#boss_time').text(time_left.toFixed(1)+'s.');


        
        

        var ALLdps = 0;
        for(var l = 0;l<UpgradeButton.buttons.length;l++){
        ALLdps = ALLdps + UpgradeButton.buttons[l].baseDmg * UpgradeButton.buttons[l].boughtUpgrades;
        }
        $('#dmg_s').text(ALLdps);


        $('.back_arrow').prop('hidden', ( stage==1 ) ? true:false );
        $('.next_arrow').prop('hidden', ( stagePassed==stage ) ? true:false );

    };
    refreshHTML();
    refreshIsland(true);

    




    function setHp(){
        maxhp = 10;
        for(var i=0;i<(stage-1);i++){
            maxhp=maxhp*(hpMultipler);
        }
        current=maxhp;
    }

 setInterval(function(){ 
        current -= UpgradeButton.getAllDmg();
        for(var i=0;i<SkillButton.skills.length;i++){
            if(SkillButton.skills[i].isOn){
                
            }
        }


        if (current <= 0) {
            level++;
            setHp();
            gold += stage; // trza dodac mnoznik od stageow konkretny
            if(b_getBonusgold) { gold+=stage*10;b_getBonusgold=0; };
            
            b_startBossTime=false; time_left=bossTime;
            refreshIsland(true);

            if(level > maxLevel){
                if (stagePassed == stage){
                    stage ++;
                    stagePassed++;
                    setHp();
                    level = 1;
                }
                refreshIsland(true);
            }
            if(stagePassed>stage && level > maxLevel){
                level=maxLevel;
            }
            if( ((stage %10) == 0) && level == maxLevel){
                setHp();
                maxhp=maxhp*3;
                current=maxhp;
                b_startBossTime=true;
                b_getBonusgold=1;
            }
            $('#pills-logs').append('<span>Dostałeś: '+stage+' Golda</span><br/>');
            $("#pills-logs").animate({ scrollTop: 20000000 }, "slow");
        }
        if(b_startBossTime){
            time_left -= 0.1;
            if(time_left < 0){
                setHp();
                maxhp=maxhp*3;
                current=maxhp;
                time_left=bossTime;
            }

        }
        dpsMeter -=0.1;
        dps += UpgradeButton.getAllDmg();
        if(dpsMeter <= 0){
            dpsMeter=1.0;
            $('#dps').text(dps.toFixed(1)+' dmg.');
            dps=0;
        }


        refreshHTML();

        }, 100);

    //  ulepszanie podstawowego click powera
    $('#clickUpgrade').click(function(){
        if(gold>=clickUpgradePrice){
            gold -= clickUpgradePrice;
            clickUpgradePrice *=2;
            clickDmg +=1;
            clickUpgradesBought++;
            cost10 = clickUpgradePrice*(2*10) ;
            cost25 = clickUpgradePrice*(2*25) ;
            }
        });

    $('#buy10').click(function(){
        if(gold>=cost10){
            gold -= cost10;
            clickDmg +=1*10;
            clickUpgradesBought += 10;
            clickUpgradePrice *=2*10;
            cost10 = clickUpgradePrice*(2*10) ;
            cost25 = clickUpgradePrice*(2*25) ;
            refreshHTML();
        }
    });

    $('#buy25').click(function(){
        if(gold>=cost25){
            gold -= cost25;
            clickDmg +=1*25;
            clickUpgradesBought += 25;
            clickUpgradePrice *=2*25;
            cost10 = clickUpgradePrice*(2*10) ;
            cost25 = clickUpgradePrice*(2*25) ;
            refreshHTML();
        }
    });

    
    // zadawanie obrażen
   $('.click_area').click(function(){
        clickCount++;
        current -= clickDmg;
        dps+=clickDmg;

        $( "#mob_image" ).animate({
            height: "22%",
        }, 50 );
        $( "#mob_image" ).animate({
            height: "20%",
        }, 50 );
    });


    $('.next_arrow').click(function(){
        stage++;
        setHp();
        level = 1;
        b_startBossTime=false;
        time_left=bossTime;
        refreshHTML();
        refreshIsland(true);

    });

    $('.back_arrow').click(function(){
        if(stage > 1){
            stage--;
            setHp();
        level = 1;
        b_startBossTime=false;
        time_left=bossTime;
        refreshHTML();
        refreshIsland(false);
        }
    });



// zapisywanie cookis testy --- jeszcze nie skonczone kminie jakby to zrobic :D
// ale z tego co zdolalem zauważyć pewnie bede musial cookie robic od strony serwera
// a nie od javy jak chce to miec w bazie danych, bo java jak sie f5 daje to od nowa dane zczytuje
// i cookie musial by byc na sztywno napisany zeby to dzialalo a ja tak nie chce :(


    $('#error_div').hide();
    $('#cookie_form').submit(function() {
        $.ajax({
            data: $(this).serialize(),
            type: $(this).attr('method'),
            url: $(this).attr('action'),
            success: function(data) {
                console.log(data);
                var date = new Date();
                var time = date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds();
                $('#error_div').hide().html('<p>'+data.message+' | Current hour: '+time+'</p>').fadeIn(2000).fadeOut(5000);
                var userCookie = data.userid;
            },
            error: function(data) {
                $('#error_div').html(data); 
            }
        });
        return false;
    });



    save();
    function save(){
    setTimeout(function() {
        Cookies.set('click_count', clickCount );
        Cookies.set('current_gold', gold);
        Cookies.set('stage', stage);
        Cookies.set('stage_passed', stagePassed);
        Cookies.set('click_upgrades_bought', clickUpgradesBought);
        Cookies.set('var_o', o);
        Cookies.set('clickUpgradePrice', clickUpgradePrice);
        $('#cookie_id').val(Cookies.get('cookieIds'));
        $('#clickUpgradePrice').val(Cookies.get('clickUpgradePrice'));
        $('#click_count').val(Cookies.get('click_count'));
        $('#current_gold').val(Cookies.get('current_gold'));
        $('#stage').val(Cookies.get('stage'));
        $('#stage_passed').val(Cookies.get('stage_passed'));
        $('#click_upgrades_bought').val(Cookies.get('click_upgrades_bought'));
        $('#var_o').val(Cookies.get('var_o'));
        $('#cookie_form').submit();
        save();
    }, 10000);}


// load save



});



</script>