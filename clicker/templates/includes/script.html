<script>
$(document).ready(function(){
    


    // zmienne pomocnicze
    var o = -1;
    // zmienne
    var clickCount=0; // ilosc nacisniec
    var stage = 1; // aktualny stage
    var stagePassed = 1; // ilosc stage ktore przeszedles
    var clickDmg = 1; // aktualny click dmg
    var level = 1; // aktualny level na danym stage
    var maxLevel = 10; // ilosc leveli
    var gold = 30000; // base gold 
    var maxhp = 10; // pierwsze hp mobka
    var current = maxhp; // aktualne hp
    var hpbar =  current/maxhp*100; // aktualny hp bar w %%
    var hpMultipler = 1.12; // huj wi cos wojtek napisal xd
    var baseCost=10; // mnoznik do ceny ulepszenia na klikanie x1 
    var priceMultipler = 1.1; // mnoznik do ceny ulepszenia na klikanie x2
    var goldUpgradesAmount = 1; // mnoznik do ceny ulepszenia na klikanie x3
    var actualPrice = baseCost*priceMultipler*goldUpgradesAmount; // aktuwalna cena ulepszenia
    var clikMultipler = 1;
    const numberOfUpgrades = {{ units.count }}; // liczba obecnych ulepszen 
            {% comment %} ) {% endcomment %}
    var visibleUpgrades = -1; // obecnie pokazane upgrade
    var time_left = 30;
    var b_startTime=0;
    var b_getBonusgold=0;
    
    // zmienne wysp i mobków z bazy danych
    var islands = [];
    var islands_images = [];
    var islands_ends = [];

    var mobs = [];
    var mobs_images = [];
    var mobs_on_island_count = [];


    
    {% for island in islands %}
        islands.push('{{ island.island_name }}');
        islands_images.push('{{ island.island_image.url }}');
        islands_ends.push({{ island.ends }});
        {% for mob in island.units.all %}
        mobs.push('{{ mob.mob_name }}');
        mobs_images.push('{{ mob.mob_image.url }}');
        {% endfor %}
        mobs_on_island_count.push({{ island.units.count }});
    {% endfor %}
                                                                                                                    {% comment %} ) {% endcomment %}


    function multiplierPrice(x, z){
        var final = 0;
        var goldUpgradesCount = goldUpgradesAmount;
        for(var i=1; i <= x; i++){
            final += baseCost*goldUpgradesCount*z;
            goldUpgradesCount++;
        }
        return final.toFixed(0);
    }; 
    var cost10 = multiplierPrice(10, priceMultipler);
    var cost25 = multiplierPrice(25, priceMultipler);
       
       
       class Upgrade{
        constructor(nameId,nameOfUpgrade,tier){
            this.nameId=nameId;
            this.nameOfUpgrade=nameOfUpgrade;
            this.tier = tier;
            this.boughtUpgrades=0;
            this.baseDmg=0.5;
            this.price=0;
            this.discountMultipler=1.0;
            this.priceMultipler=1.15;
            this.checked = false;
           // $(this.nameId).click(this.buyUpgrade()); 
        }
        dealDmg(){
            current -= this.baseDmg*this.boughtUpgrades/10*this.tier;
        }
        buyUpgrade(){
            if(gold >= (this.price*this.discountMultipler)){
                gold -= this.price*this.discountMultipler;
                this.boughtUpgrades++;
                console.log("Kupiłeś upgrade dla "+this.nameOfUpgrade+ " za " +this.price+ " golda!" );
                this.price = this.price*this.priceMultipler;
            }
        }
        checkVisible(){
            if(gold >= this.price){
                if(this.checked == false){
                    if(visibleUpgrades < numberOfUpgrades ){
                    this.checked = true;
                    visibleUpgrades++;
                    }
                }
                
            }
            $('#upgrade'+visibleUpgrades.toString()).prop('hidden', false);
        }
        checkUpgrade(){
            if(gold < (this.price*this.discountMultipler)){
            $(''+this.nameId+'').prop('disabled', true);
            }else{
                $(''+this.nameId+'').prop('disabled', false);
            }
        }
        refreshPriceAndCount(){
            $(this.nameId+'_count').text(this.boughtUpgrades);
            $(this.nameId+'_cost').text(this.price.toFixed(0));
        }

    };
       
        // juz nie trzeba tego usuwac aby zmienic kolorki :danych
            {% comment %} ) {% endcomment %}
        //
       
       
    var upgradeNames = [];   // to do klasy Upgrade
    var baseUpgradePrices = [];  //  to do klasy Upgrade
    var upgradesButtonsArray = [];

    {% for unit in units %}
        upgradeNames.push('{{ unit.unit_name }}');
        baseUpgradePrices.push({{ unit.unit_default_cost }}); 
    {% endfor %}
            

            // juz nie trzeba tego usuwac aby zmienic kolorki :danych
                {% comment %} ) {% endcomment %}
            //
    
    for(var i = 0;i<numberOfUpgrades;i++){
        upgradesButtonsArray[i]=new Upgrade( "#upgrade"+i , upgradeNames[i], i+1 );
        upgradesButtonsArray[i].price=baseUpgradePrices[i];
    };


    // zmienne random dla moba
    var last_mobs = 0;
    var min = last_mobs;
    var max = last_mobs + mobs_on_island_count[o+1] - 1;
    var islands_count = {{ islands.count }};
    $('.island').css('background-image', 'url('+islands_images[o+1]+')');

    function refreshIsland(next){
        if(islands_count >= o){
            if(next == true){
                if(stage-1 == islands_ends[o+1] ){
                    o++;
                    last_mobs = max;
                    min = max+1;
                    max = max + mobs_on_island_count[o+1];
                };
            }else{
                if(stage == islands_ends[o] ){
                    if(stage == islands_ends[0]){
                        o = -1;
                        last_mobs = 0;
                        min = last_mobs;
                        max = last_mobs + mobs_on_island_count[o+1] - 1;
                    }else{
                        min = min - mobs_on_island_count[o];
                        max = max - mobs_on_island_count[o+1];
                        o--;
                    };};
                };
            };
            minV = Math.ceil(min);
            maxV = Math.floor(max);
            k = Math.floor(Math.random() * (max - min + 1)) + min;


            $('#mob_image').attr("src",  mobs_images[k] );
            $('#mob_name').text(mobs[k]);
            $('#level_name').text(islands[o+1]);
            $('.island').css('background-image', 'url('+islands_images[o+1]+')');
    };

    function refreshHTML(){

        hpbar =  current/maxhp*100;
        $('#boughtUpgrades').text(goldUpgradesAmount);
        $('#goldPrice').text(actualPrice);
        $('#gold').text(gold.toFixed(0));
        $('#level').text(" "+level);
        $('#maxLevel').text(maxLevel);
        $('#stage').text(stage);
        $('#max_hp').text(maxhp.toFixed(0));
        $('.current_hp').text(current.toFixed(0));
        $('#clickDmg').text(clickDmg.toFixed(2));
        $('.progress-bar').css('width', hpbar.toFixed(2)+'%');
        $('#clickCount').text(clickCount);
        $('#cost25').text(cost25);
        $('#cost10').text(cost10);
        $('#boss_time').text(time_left.toFixed(1)+'s.');
        
        var totalDmg = 0;
        var ALLdps = 0;
         
        for(var l = 0;l<numberOfUpgrades;l++){
        ALLdps = ALLdps + upgradesButtonsArray[l].baseDmg * upgradesButtonsArray[l].boughtUpgrades * upgradesButtonsArray[l].tier;
        }
        $('#dmg_s').text(ALLdps);

        if (stage == 1) {
            $('.back_arrow').css('overflow', 'hidden');
        }else{
            $('.back_arrow').css('overflow', 'visible');
        }
        if (stagePassed == stage) {
            $('.next_arrow').css('overflow', 'hidden');
        }else{
            $('.next_arrow').css('overflow', 'visible');
        }


    };
    refreshHTML();
    refreshIsland(true);

    

    {% for unit in units %}
    $('#upgrade{{ unit.unit_id }}').click(function(){upgradesButtonsArray[{{ unit.unit_id }}].buyUpgrade()});
    {% endfor %}

    setInterval(function(){ 
        for(var i = 0;i<numberOfUpgrades; i++){
            upgradesButtonsArray[i].dealDmg();
        }
        if (current <= 0) {
            level++;
            maxhp = 10;
            for(var i=0;i<(stage-1);i++){
                maxhp=maxhp*(hpMultipler);
            }
            current=maxhp;
            gold += 101 + 1.2*stage; // trza dodac mnoznik od stageow konkretny
            if(b_getBonusgold) { gold+=2000;b_getBonusgold=0; };
            b_startTime=0; time_left=30;
            $('#boss_time').prop('hidden', true);
            refreshIsland(true);

        if(level > maxLevel){
            if (stagePassed == stage){
            stage ++;
            stagePassed++;
            maxhp = maxhp*(hpMultipler);
            current = maxhp;
            }
            refreshIsland(true);
            level = 1;
        }
        if(((stage %10)==0) && level == maxLevel){
            maxhp = 10;
            $('#boss_time').prop('hidden', false);
            for(var i=0;i<(stage-1);i++){
                maxhp=maxhp*(hpMultipler);
            }
            maxhp=maxhp*3;
            current=maxhp;
            b_startTime=1;
            b_getBonusgold=1;
            }
        }
        if(b_startTime){
            time_left -= 0.1;
            if(time_left < 0){
                maxhp = 10;
                for(var i=0;i<(stage-1);i++){
                maxhp=maxhp*(hpMultipler);
                }
                maxhp=maxhp*3;
                current=maxhp;
                time_left=30;
                
            }

        }

        for(var i = 0;i<numberOfUpgrades;i++){
            upgradesButtonsArray[i].refreshPriceAndCount();
            upgradesButtonsArray[i].checkUpgrade();
            upgradesButtonsArray[i].checkVisible();
            
        }
        
        refreshHTML();

        }, 100);




    //  ulepszanie podstawowego click powera
    $('#clickUpgrade').click(function(){
        if(gold>=actualPrice){
            gold -= actualPrice;
            clikMultipler += 0.1;
            clickDmg = clickDmg + (1*clikMultipler);
            goldUpgradesAmount++;
            actualPrice=baseCost*priceMultipler*goldUpgradesAmount;
            cost10 = multiplierPrice(10, priceMultipler);
            cost25 = multiplierPrice(25, priceMultipler);
            }
        });

    $('#buy10').click(function(){
        if(gold>=cost10){
            gold -= cost10;
            clikMultipler += 1;
            clickDmg = clickDmg + (1*clikMultipler);
            goldUpgradesAmount += 10;
            actualPrice = baseCost*priceMultipler*goldUpgradesAmount;
            cost10 = multiplierPrice(10, priceMultipler);
            cost25 = multiplierPrice(25, priceMultipler);
            refreshHTML();
        }
    });

    $('#buy25').click(function(){
    if(gold>=cost25){
        gold -= cost25;
        clikMultipler += 2.5;
        clickDmg = clickDmg + (1*clikMultipler);
        goldUpgradesAmount += 25;
        actualPrice = baseCost*priceMultipler*goldUpgradesAmount;
        cost25 = multiplierPrice(25, priceMultipler);
        cost10 = multiplierPrice(10, priceMultipler);
        refreshHTML();
        }
    });

    
    // zadawanie obrażen
    $('.click_area').click(function(){
        // funckja klikania
        clickCount++;
        current -= clickDmg;
    });


        // zmiana stage ++
    $('.next_arrow').click(function(){
        stage++;
        maxhp = maxhp*(hpMultipler);
        current=maxhp;
        level = 1;
        b_startTime=0;
        time_left=30;
        refreshIsland(true);
        refreshHTML();

    });
        // zmiana stage --
    $('.back_arrow').click(function(){

        if(stage > 1){
            stage--;
        }
        if(stage==1){
            maxhp=10;
            current=maxhp;
        }else{
        maxhp = 10;
        for(var i=0;i<(stage-1);i++){
            maxhp=maxhp*(hpMultipler);
        }
        current=maxhp;
        }
        level = 1;
        b_startTime=0;
        time_left=30;
        refreshIsland(false);
        refreshHTML();
    });
    
        
});



    

</script>