<script>
$(document).ready(function(){
    


    // zmienne pomocnicze
    var o = -1;
    // zmienne
    var clickCount=0; // ilosc nacisniec
    var stage = 1; // aktualny stage
    var stagePassed = 1; // ilosc stage ktore przeszedles
    var clickDmg = 1; // aktualny click dmg
    var level = 1; // aktualny level na danym stage
    var maxLevel = 10; // ilosc leveli
    var gold = 30000; // base gold 
    var maxhp = 10; // pierwsze hp mobka
    var current = maxhp; // aktualne hp
    var hpbar =  current/maxhp*100; // aktualny hp bar w %%
    var hpMultipler = 1.12; // huj wi cos wojtek napisal xd
    var baseCost=10; // mnoznik do ceny ulepszenia na klikanie x1 
    var priceMultipler = 1.1; // mnoznik do ceny ulepszenia na klikanie x2
    var goldUpgradesAmount = 1; // mnoznik do ceny ulepszenia na klikanie x3
    var actualPrice = baseCost*priceMultipler*goldUpgradesAmount; // aktuwalna cena ulepszenia
    var clikMultipler = 1;
    var visibleUpgrades = -1; // obecnie pokazane upgrade
    var time_left = 30;
    var b_startTime=0;
    var b_getBonusgold=0;
    
    // zmienne wysp i mobków z bazy danych
    var islands = [];
    var islands_images = [];
    var islands_ends = [];

    var mobs = [];
    var mobs_images = [];
    var mobs_on_island_count = [];


    
    {% for island in islands %}
        islands.push('{{ island.island_name }}');
        islands_images.push('{{ island.island_image.url }}');
        islands_ends.push({{ island.ends }});
        {% for mob in island.units.all %}
        mobs.push('{{ mob.mob_name }}');
        mobs_images.push('{{ mob.mob_image.url }}');
        {% endfor %}
        mobs_on_island_count.push({{ island.units.count }});
    {% endfor %}
                                                                                                                    {% comment %} ) {% endcomment %}


    function multiplierPrice(x, z){
        var final = 0;
        var goldUpgradesCount = goldUpgradesAmount;
        for(var i=1; i <= x; i++){
            final += baseCost*goldUpgradesCount*z;
            goldUpgradesCount++;
        }
        return final.toFixed(0);
    }; 
    var cost10 = multiplierPrice(10, priceMultipler);
    var cost25 = multiplierPrice(25, priceMultipler);
       
       
      class Upgrade{

            static upgradeNames = [];   
            static baseUpgradePrices = [];  
            static upgradesButtonsArray = [];
            static numberOfUpgrades = {{ units.count }};
        constructor(nameId,nameOfUpgrade){
            this.nameId=nameId;
            this.nameOfUpgrade=nameOfUpgrade;
            this.baseDmg=0.5;
            this.boughtUpgrades=0;
            this.price=0;
            this.discountMultipler=1.0;
            this.priceMultipler=1.15;
            this.checked = false;
        }
        static Init(){
         {% for unit in units %}
          this.upgradeNames.push('{{ unit.unit_name }}');
          this.baseUpgradePrices.push({{ unit.unit_default_cost }}); 
         {% endfor %}
         for(var i = 0;i<this.numberOfUpgrades;i++){
            this.upgradesButtonsArray[i]=new Upgrade( "#upgrade"+i , Upgrade.upgradeNames[i] );
            this.upgradesButtonsArray[i].price=Upgrade.baseUpgradePrices[i];
            this.upgradesButtonsArray[i].baseDmg +=1;
         };


        }
        static dealDmg(){
            for(var i = 0;i<this.numberOfUpgrades;i++){
            current -= this.upgradesButtonsArray[i].baseDmg*this.upgradesButtonsArray[i].boughtUpgrades/10;
            }
        }
        buyUpgrade(){
            if(gold >= (this.price*this.discountMultipler)){
                gold -= this.price*this.discountMultipler;
                this.boughtUpgrades++;
                console.log("Kupiłeś upgrade dla "+this.nameOfUpgrade+ " za " +this.price+ " golda!" );
                this.price = this.price*this.priceMultipler;
            }
        }
        static refreshButtons(){
            for(var i = 0;i<this.numberOfUpgrades;i++){
            $(this.upgradesButtonsArray[i].nameId+'_count').text(this.upgradesButtonsArray[i].boughtUpgrades);
            $(this.upgradesButtonsArray[i].nameId+'_cost').text(this.upgradesButtonsArray[i].price.toFixed(0));
            if(gold < (this.upgradesButtonsArray[i].price*this.upgradesButtonsArray[i].discountMultipler)){
                $(''+this.upgradesButtonsArray[i].nameId+'').prop('disabled', true);
             }else{
                $(''+this.upgradesButtonsArray[i].nameId+'').prop('disabled', false);
            }
            if(gold >= this.upgradesButtonsArray[i].price){
                if(this.upgradesButtonsArray[i].checked == false){
                    if(visibleUpgrades < this.numberOfUpgrades ){
                    this.upgradesButtonsArray[i].checked = true;
                    visibleUpgrades++;
                    }
                }
                
            }
            $('#upgrade'+visibleUpgrades.toString()).prop('hidden', false);
            }
        }

    };
    Upgrade.Init();
       
            {% comment %} ) {% endcomment %}

       
    

            // juz nie trzeba tego usuwac aby zmienic kolorki :danych
                {% comment %} ) {% endcomment %}
            //



    // zmienne random dla moba
    var last_mobs = 0;
    var min = last_mobs;
    var max = last_mobs + mobs_on_island_count[o+1] - 1;
    var islands_count = {{ islands.count }};
    $('.island').css('background-image', 'url('+islands_images[o+1]+')');

    function refreshIsland(next){
        if(islands_count >= o){
            if(next == true){
                if(stage-1 == islands_ends[o+1] ){
                    o++;
                    last_mobs = max;
                    min = max+1;
                    max = max + mobs_on_island_count[o+1];
                };
            }else{
                if(stage == islands_ends[o] ){
                    if(stage == islands_ends[0]){
                        o = -1;
                        last_mobs = 0;
                        min = last_mobs;
                        max = last_mobs + mobs_on_island_count[o+1] - 1;
                    }else{
                        min = min - mobs_on_island_count[o];
                        max = max - mobs_on_island_count[o+1];
                        o--;
                    };};
                };
            };
            minV = Math.ceil(min);
            maxV = Math.floor(max);
            k = Math.floor(Math.random() * (max - min + 1)) + min;


            $('#mob_image').attr("src",  mobs_images[k] );
            $('#mob_name').text(mobs[k]);
            $('#level_name').text(islands[o+1]);
            $('.island').css('background-image', 'url('+islands_images[o+1]+')');
    };

    function refreshHTML(){
            Upgrade.refreshButtons();
        
        $('#boughtUpgrades').text(goldUpgradesAmount);
        $('#goldPrice').text(actualPrice);
        $('#gold').text(gold.toFixed(0));
        $('#level').text(" "+level);
        $('#maxLevel').text(maxLevel);
        $('#stage').text(stage);
        $('#max_hp').text(maxhp.toFixed(0));
        $('.current_hp').text(current.toFixed(0));
        $('#clickDmg').text(clickDmg.toFixed(2));
        hpbar =  current/maxhp*100;
        $('.progress-bar').css('width', hpbar.toFixed(2)+'%');
        $('#clickCount').text(clickCount);
        $('#cost25').text(cost25);
        $('#cost10').text(cost10);
        $('#boss_time').text(time_left.toFixed(1)+'s.');
        

        var ALLdps = 0;
        for(var l = 0;l<Upgrade.numberOfUpgrades;l++){
        ALLdps = ALLdps + Upgrade.upgradesButtonsArray[l].baseDmg * Upgrade.upgradesButtonsArray[l].boughtUpgrades;
        }
        $('#dmg_s').text(ALLdps);

        if (stage == 1) {
            $('.back_arrow').css('overflow', 'hidden');
        }else{
            $('.back_arrow').css('overflow', 'visible');
        }
        if (stagePassed == stage) {
            $('.next_arrow').css('overflow', 'hidden');
        }else{
            $('.next_arrow').css('overflow', 'visible');
        }


    };
    refreshHTML();
    refreshIsland(true);

    
    {% for unit in units %}
    $('#upgrade{{ unit.unit_id }}').click(function(){Upgrade.upgradesButtonsArray[{{ unit.unit_id }}].buyUpgrade()});
    {% endfor %}



    function setHp(){
        maxhp = 10;
        for(var i=0;i<(stage-1);i++){
            maxhp=maxhp*(hpMultipler);
        }
        current=maxhp;
    }

 setInterval(function(){ 
            Upgrade.dealDmg();

        if (current <= 0) {
            level++;
            setHp();
            gold += stage; // trza dodac mnoznik od stageow konkretny
            if(b_getBonusgold) { gold+=stage*10;b_getBonusgold=0; };

            b_startTime=0; time_left=3;
            refreshIsland(true);

             if(level > maxLevel){
                   if (stagePassed == stage){
                   stage ++;
                    stagePassed++;
                    setHp();
               }
            refreshIsland(true);
            level = 1;
                }
          if( ((stage %10) == 0) && level == maxLevel){
            setHp();
            maxhp=maxhp*3;
            current=maxhp;
            b_startTime=1;
            b_getBonusgold=1;

            
         }
        }
        if(b_startTime){
            time_left -= 0.1;
            if(time_left < 0){
                setHp();
                maxhp=maxhp*3;
                current=maxhp;
                time_left=3;
            }

        }

        refreshHTML();

        }, 100);




    //  ulepszanie podstawowego click powera
    $('#clickUpgrade').click(function(){
        if(gold>=actualPrice){
            gold -= actualPrice;
            clikMultipler += 0.1;
            clickDmg = clickDmg + (1*clikMultipler);
            goldUpgradesAmount++;
            actualPrice=baseCost*priceMultipler*goldUpgradesAmount;
            cost10 = multiplierPrice(10, priceMultipler);
            cost25 = multiplierPrice(25, priceMultipler);
            }
        });

    $('#buy10').click(function(){
        if(gold>=cost10){
            gold -= cost10;
            clikMultipler += 1;
            clickDmg = clickDmg + (1*clikMultipler);
            goldUpgradesAmount += 10;
            actualPrice = baseCost*priceMultipler*goldUpgradesAmount;
            cost10 = multiplierPrice(10, priceMultipler);
            cost25 = multiplierPrice(25, priceMultipler);
            refreshHTML();
        }
    });

    $('#buy25').click(function(){
    if(gold>=cost25){
        gold -= cost25;
        clikMultipler += 2.5;
        clickDmg = clickDmg + (1*clikMultipler);
        goldUpgradesAmount += 25;
        actualPrice = baseCost*priceMultipler*goldUpgradesAmount;
        cost25 = multiplierPrice(25, priceMultipler);
        cost10 = multiplierPrice(10, priceMultipler);
        refreshHTML();
        }
    });

    
    // zadawanie obrażen
   $('.click_area').click(function(){
        clickCount++;
        current -= clickDmg;
    });


    $('.next_arrow').click(function(){
        stage++;
        setHp();
        level = 1;
        b_startTime=0;
        time_left=3;
        refreshIsland(true);

    });

    $('.back_arrow').click(function(){
        if(stage > 1){
            stage--;
            setHp();
        level = 1;
        b_startTime=0;
        time_left=3;
        refreshIsland(false);
        }
    });
    
        
});


    

</script>